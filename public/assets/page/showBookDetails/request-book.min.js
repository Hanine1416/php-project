function validateStep3(){var e,s=!0,t=$("#step3");return t.hasClass("hidden")||(e=t.find(".validate:visible"),t.find(".error").remove(),$.each(e,function(e,t){var a;$(t).val()||(a='<span class="error">'+DOMPurify.sanitize($(t).prop("title"))+"</span>",$(t).addClass("warning").parent().append(a),s=!1)})),s}function validateStep4(){var s=!0,e=$("#step4"),t=e.find(".validate:visible");t.removeClass("warning"),e.find(".error").remove(),$.each(t,function(e,t){var a;$(t).val()||(a='<span class="error">'+DOMPurify.sanitize($(t).prop("title"))+"</span>",$(t).addClass("warning").parent().append(a),s=!1)});var a=new RegExp(/^\d+$/),o=new RegExp(/[A-z]{3,}/g),e=$("#courseType"),t=$("#studentsNumber");return null!=e.val()&&(e.val().match(o)||e.hasClass(".warning")||(e.addClass("warning"),s=!1)),(!$.isNumeric(t.val())||t.val()<=0||null==t.val().match(a))&&""!==t.val()&&(a=DOMPurify.sanitize(t.data("msg")),t.addClass("warning").parent().append('<span class="error">'+a+"</span>"),s=!1),s}function validateStep5(){var a=!0,e=$("#step5"),t=e.find(".checkbox__input");return t.removeClass("warning"),e.hasClass("hidden")||(e.find(".error").remove(),0===$("#step5 input[type=radio]:checked").length&&$.each(t,function(e,t){$(t).addClass("warning"),a=!1})),a}function resetStepsForNextInstitution(){$('#step3 input:not([type="radio"],[type="checkbox"])').val(""),$('#step4 input:not([type="radio"],[type="checkbox"])').val(""),$("#courseType").val("").trigger("change"),$("#courseLevel").val("").trigger("change"),$("#core,#recommended,#supplementary,#undecided").prop("checked",!1).trigger("change"),$("#endDate").datepicker("setDate",null),$("#startDate").datepicker("setDate",null),$("#noCurrentTitle").prop("checked",!0).trigger("change"),$(".modal-step .error").remove(),$(".modal-step .warning").removeClass("warning")}function submitBookRequest(t,a){var e={"bookRequest[bookIsbn]":t.bookIsbn,"bookRequest[bookFormat]":t.bookFormat,"bookRequest[preOrder]":t.preOrder,"bookRequest[institutions]":t.institutions,"bookRequest[addressId]":t.addressId,country:t.country},s=$("#submit-request-btn");s.addClass("loading");var o=$("#confirm-btn");o.addClass("loading"),$.ajax({url:$("#formBookRequest").data("url"),method:"POST",data:e,success:function(e){s.removeClass("loading"),o.removeClass("loading"),$("#step1").data("first-request",!1),a(e.success,t,e)},error:function(e){s.removeClass("loading"),o.removeClass("loading"),401===e.status&&showErrorBox($("#loggedOutMsg").text())}})}function sendRequestData(e){validateStep3()&&validateStep4()&&submitBookRequest(e,function(e,o,t){if(e){$("#step5").removeClass("active"),$("#step6").removeClass("active"),$("#step7").addClass("active");let e=$(".request-book-btn"),t=$("input[name='radio-group']:checked"),a=t.attr("data-format","Digital"),s=$("#print-request");t.attr("data-format",o.bookFormat),t.addClass("radioDisabled"),t.attr("disabled","true"),t.prop("checked",!1),(1===o.preOrder?$("#preorder"):$("#request")).show(),"Print"===o.bookFormat?(a&&(a.addClass("radioDisabled"),a.attr("disabled","true"),t.prop("checked",!1),e.text(t.data("requested")),$(".info-print-requested").removeClass("hidden")),e.removeClass("request-book-btn").addClass("btnDisabled")):"Digital"===o.bookFormat&&1===$("input[name='radio-group']").length?e.removeClass("request-book-btn").addClass("btnDisabled"):(s.prop("checked",!0),"request"===s.data("request")?e.text("request print"):e.text($("#preorder-book").text()),"request"!=s.data("request")&&(e.attr("data-preorder","1"),o.preorder=1))}})}function newBookRequest(e,t,a){return{bookIsbn:e,bookFormat:t,preOrder:a?1:0,institutions:[],addressId:""}}function resetRequestModal(){let e=$("#step1"),t=$("#institutions-selector");resetStepsForNextInstitution(),$(".modal-step").removeClass("active"),$("#courseType").val("").trigger("change"),$("#courseLevel").val("").trigger("change"),e.addClass("active"),$("#singleInstitution").prop("checked",!0).trigger("change"),$("#core,#recommended,#supplementary,#undecided").prop("checked",!1).trigger("change"),$('input:not([type="radio"],[type="checkbox"])').val(""),$('[name="institution-check-list"]:not(.my-primary)').prop("checked",!1).trigger("change"),$('[name="institution-check-list"].my-primary').prop("checked",!0).trigger("change"),$("#institutions-selector option.my-primary").prop("selected",!0).trigger("change"),$("#checkOneInstitutionMsg").hide(),$("#addressList").show(),$("#confirmAddress").hide(),!0===e.data("first-request")&&($("#institutions-selector option").remove(),$("#institution-check-container").empty()),t.attr("data-first",0),(0===t.data("inst")||0===t.data("first")&&!0===e.data("first-request"))&&($("#institution_isPrimary").prop("checked",!0),$("#institution_isPrimary").attr("disabled",!0)),t.data().inst=0}$(document).ready(function(){"false"==$("#print-request").parent().attr("data-show")&&$("#print-request").parent().remove(),1===$(".radio-request-btn").length&&1===$("#print-request").length&&($("#print-request").hasClass("radioDisabled")?$(".request-book-btn").addClass("btnDisabled"):$("#print-request").prop("checked",!0));var e=new Date,t=e.getDate(),a=e.getMonth(),e=e.getFullYear(),s=t+"-"+a+"-"+(e+5),o=t+"-"+a+"-"+(e-1),r=$("#startDate"),n=$("#endDate"),l=$("#courseType"),c=$("#courseLevel"),i=$(".box");i.find("#box-confirm").text($("#box-msg-yes").text()),i.find("#box-cancel").text($("#box-msg-no").text()),r.datepicker({autoclose:!0,container:r.closest(".modal-step"),minDate:new Date,maxDate:new Date,startDate:o,endDate:s,orientation:"top",format:"dd-M-yyyy",language:currentLang,todayHighlight:!0,templates:{leftArrow:'<i class="fa fa-chevron-left"></i>',rightArrow:'<i class="fa fa-chevron-right"></i>'},widgetPositioning:{horizontal:"auto",vertical:"auto"}}).on("changeDate",function(e){e.date?((e=new Date(e.date.valueOf())).setDate(e.getDate()+1),n.datepicker("setStartDate",e)):n.datepicker("setStartDate",o)}),n.datepicker({autoclose:!0,container:n.closest(".modal-step"),minDate:new Date,maxDate:new Date,startDate:o,endDate:s,orientation:"top",format:"dd-M-yyyy",language:currentLang,todayHighlight:!0,clearBtn:!0,templates:{leftArrow:'<i class="fa fa-chevron-left"></i>',rightArrow:'<i class="fa fa-chevron-right"></i>'},widgetPositioning:{horizontal:"auto",vertical:"auto"}}).on("changeDate",function(e){e.date?((e=new Date(e.date.valueOf())).setDate(e.getDate()-1),r.datepicker("setEndDate",e)):r.datepicker("setEndDate",s)});var u=null,p=null,e=$("#institutions-selector");e.select2({placeholder:"",dropdownParent:e.parent()}),l.select2({placeholder:"",dropdownParent:l.parent()});e=$("#courseLevel").attr("placeholder");c.select2({placeholder:e,dropdownParent:c.parent()}),$(document).on("click","#core,#recommended,#supplementary,#undecided",function(){$("#core,#recommended,#supplementary,#undecided").removeClass("warning")}),$(document).on("change",'[name="multipleInstitution"]',function(){var e=$("#multiple-institutions"),t=$("#single-institution");$("#multipleInstitution").is(":checked")?(e.show(),t.hide()):(t.show(),e.hide())}),$(document).on("click",".new-level",function(){$(".level-selector-block").hide(),$(".level-text-block").show().find("input").val("")}),$(document).on("click",".cancel-level",function(){$(".level-selector-block").show().find("select").val("").trigger("change"),$(".level-text-block").hide()}),$(document).on("click",".complete-url",function(e){e.stopPropagation(),e.preventDefault(),i.attr("class","box active error-info"),i.find(".error-msg").html(DOMPurify.sanitize($("#complete-url-msg").html())),$("body").addClass("modal-open"),i.on("click","#box-ok",function(){i.removeClass("active error-info"),i.off("click"),$("body").removeClass("modal-open")})}),$(document).on("click",".request-book-btn:not(.complete-url)",function(){resetRequestModal();let e=$("input[name='radio-group']:checked");var t=e.data("isbn"),a=e.data("format"),s=void 0!==e.data("preorder");u=newBookRequest(t,a,s),$(".request-book-modal").show().addClass("active"),modalFix(function(){$("body,html").addClass("modal-open active-request scrollable")}),$(".request-book-modal .close").show()}),$(document).on("click",".goStep:not(.loading)",function(){var e=$(this).data("target-step"),t=!0,a=$(".select-address"),s=$("#endDate");let o=$("#step1"),r=$("#singleInstitution");switch(e){case"step2":(0===$("#institutions-selector").data("inst")&&!0===o.data("first-request")||0===$("#institutions-selector option").length)&&$("#new-institution-btn").click();break;case"step3":if(r.is(":checked")){$(".current-inst-name").hide();let e=$("#institutions-selector option:selected");!1===o.data("first-request")?p={institutionName:e.text(),institutionId:e.attr("value"),done:!1}:(p={institutionName:e.text(),institutionId:""!==e.attr("value")?e.attr("value"):e.data("institution-id"),institution:e.data("institution"),institutionInstId:e.data("institution-id"),department:e.data("department"),departmentId:e.data("department-id"),profession:e.data("profession"),speciality:e.data("speciality"),primary:e.data("primary"),done:!1},""==e.attr("value")&&(p.institutionId=e.data("institution-id")),u.country=e.data("country")),u.institutions.push(p)}else $.each($("#multiple-institutions input:checked"),function(e,t){0===e?(!1===o.data("first-request")?p={institutionName:$(t).data("name"),institutionId:$(t).attr("value"),done:!1}:(p={institutionName:$(t).data("name"),institutionId:""!==$(t).attr("value")?$(t).attr("value"):$(t).data("institution-id"),institution:$(t).data("institution"),institutionInstId:$(t).data("institution-id"),department:$(t).data("department"),departmentId:$(t).data("department-id"),profession:$(t).data("profession"),speciality:$(t).data("speciality"),primary:$(t).data("primary"),done:!1},u.country=$(t).data("country")),u.institutions.push(p)):!1===o.data("first-request")?u.institutions.push({institutionName:$(t).data("name"),institutionId:$(t).attr("value"),done:!1}):(u.institutions.push({institutionName:$(t).data("name"),institutionId:""!==$(t).attr("value")?$(t).attr("value"):$(t).data("institution-id"),institution:$(t).data("institution"),institutionInstId:$(t).data("institution-id"),department:$(t).data("department"),departmentId:$(t).data("department-id"),profession:$(t).data("profession"),speciality:$(t).data("speciality"),primary:$(t).data("primary"),done:!1,course:void 0!==l.val()&&l.val()}),u.country=$(t).data("country"))}),0===u.institutions.length&&(t=!1,$("#checkOneInstitutionMsg").show()),$(".current-inst-name").text(p.institutionName).show();break;case"step4":(t=validateStep3())&&(p.bookUsedReason=$('[name="bookUsedReason"]:checked').val(),p.currentUsedBook=$("#currentUsedBook").val());break;case"step5":(t=validateStep4())&&(p.course=void 0!==l.val()&&l.val(),p.courseName=$("#courseName").val(),p.courseCode=$("#courseCode").val(),p.courseLevel=(""!==c.val()?c:$("#courseLevelInput")).val(),p.studentsNumber=$("#studentsNumber").val(),p.startDate=moment($("#startDate").val(),"DD-MMM-YYYY").format("DD-MM-YYYY"),s.val()?p.endDate=moment(s.val(),"DD-MMM-YYYY").format("DD-MM-YYYY"):p.endDate=s.val());break;case"step6":if(t=validateStep5()){var n=$(".modal-step-content").find($('[name="recLevel"]:checked'));0<n.length&&null!=n.val()&&(p.recLevel=n.val()),p.done=!0,p=null;for(var i=0;i<u.institutions.length;i++)if(!1===u.institutions[i].done){p=u.institutions[i];break}if(p)resetStepsForNextInstitution(),$(".current-inst-name").text(p.institutionName),$(this).closest(".modal-step").removeClass("active"),$("#step3").addClass("active"),t=!1;else if("Print"===u.bookFormat)if($("#step5").removeClass("active"),$("#step6").addClass("active"),0===a.length){$(".new-address-modal").addClass("no-address"),$(".btn-new-address").click();for(var d,i=0;i<u.institutions.length;i++)1===u.institutions[i].primary&&($("#address_address2").val(u.institutions[i].institution),$("#address_address3").val(u.institutions[i].department));""!==u.country&&void 0!==u.country?($("#address_country").val(u.country),$("#address_country").trigger("change")):(n=(d=$("#add-address-form")).find("#select2-address_country-container"),(d=d.find("#address_country")).val(d.data("value")),n.text(d.data("value")))}else 1===a.length&&a.first().click();else null!=$(".request-book-btn").attr("data-preorder")&&null!=$(".request-book-btn").attr("data-preorder")&&(u.preOrder=$(".request-book-btn").attr("data-preorder")),sendRequestData(u),t=!1}break;case"step7":t=!1,u.addressId=$(".address-info.active").data("address-id"),null!=$(".request-book-btn").attr("data-preorder")&&null!=$(".request-book-btn").attr("data-preorder")&&(u.preOrder=$(".request-book-btn").attr("data-preorder")),sendRequestData(u)}t&&($(this).closest(".modal-step").removeClass("active"),$("#"+e).addClass("active"))}),$(document).on("change",'[name="bookUsedReason"]',function(){var e=$("#usedBookBlock");$("#alternative").is(":checked")?e.show():e.hide()}),$(document).on("submit",".fakeForm",function(e){e.preventDefault()}),$(document).ready(function(){let e=$("#digital-request"),t=$("#print-request"),a=$(".request");0===$("input[name='radio-group']").length&&a.hide(),1<$(".radioDisabled").length||0===t.length&&e.hasClass("radioDisabled")?(a.addClass("disabled"),a.removeClass("request-book-btn").addClass("btnDisabled"),e.prop("checked","false")):(t.is(":checked")||e.hasClass("radioDisabled")&&!t.hasClass("radioDisabled")?(t.prop("checked","true"),"request"===t.data("request")?a.text($("#request-book").text()):"RPT - Reprinting"===$("#ukpubstatus").text()?a.text($("#back-stock-book").text()):(a.text($("#preorder-book").text()),a.attr("data-preorder","1"),u.preorder=1)):e.is(":checked")&&("request"===e.data("request")?a.text($("#request-book").text()):"RPT - Reprinting"===$("#ukpubstatus").text()?a.text($("#back-stock-book").text()):(a.text($("#preorder-book").text()),a.attr("data-preorder","1"))),t.click(function(){$("#digital-request").prop("checked",!1),t.prop("checked","true"),"request"===t.data("request")?a.text($("#request-book").text()):"RPT - Reprinting"===$("#ukpubstatus").text()?a.text($("#back-stock-book").text()):(a.text($("#preorder-book").text()),a.attr("data-preorder","1"),u.preorder=1)}),e.click(function(){t.prop("checked","false"),e.prop("checked","true"),"request"===e.data("request")?a.text($("#request-book").text()):"RPT - Reprinting"===$("#ukpubstatus").text()?a.text($("#back-stock-book").text()):(a.text($("#preorder-book").text()),a.attr("data-preorder","1"),u.preorder=1)}))}),$(document).on("click","#close-modal",function(e){var t=$(".request-book-modal");"step7"===t.find(".modal-step.active").attr("id")?closeModal(t):(i.attr("class","box active confirm-info"),i.find(".confirm-msg").text($("#cancel-request-msg").text()),$("body").addClass("box-above-modal"),i.on("click","#box-cancel",function(){i.removeClass("active confirm-info"),i.off("click"),$("body").removeClass("box-above-modal")}).on("click","#box-confirm",function(){i.removeClass("active confirm-info"),closeModal(t),i.off("click"),$("body").removeClass("box-above-modal"),resetRequestModal()}))}),window.innerWidth<640&&$(".modal-step-content").css("minHeight",$(".request-book-modal").height()-86),$(document).on("click",".select-address",function(e){e.preventDefault(),$(".address-info.active").removeClass("active");e=$(this).data("address-id"),e=$('.address-info[data-address-id="'+e+'"]');$("#addressList").hide(),$("#confirmAddress").show(),e.addClass("active"),e.show()}),$(document).on("click",".select-other-address",function(e){e.preventDefault(),$("#addressList").show(),$("#confirmAddress").hide(),$(".address-info").hide()}),$(document).on("keypress",".validate",function(e){if(13===e.keyCode)return e.preventDefault(),!1})});